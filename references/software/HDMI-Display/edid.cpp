#include "Arduino.h"
#include "HDMI-Display.h"

const uint8_t PROGMEM EDID::edid_unknown[EDID_SIZE] =
{
  0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
  0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
  0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
  0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
  0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
  0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
  0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
  0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF
};

const uint8_t PROGMEM EDID::edid_480x272[EDID_SIZE] =
{
  0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x5C,0x34,0x01,0x00,0x01,0x00,0x00,0x00,
  0x01,0x19,0x01,0x03,0x81,0x00,0x00,0x00,0x0A,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
  0x01,0x01,0x01,0x01,0x01,0x01,0xC4,0x09,0xE0,0x33,0x10,0x10,0x14,0x10,0x08,0x05,
  0x4A,0x00,0xE0,0x10,0x11,0x00,0x00,0x18,0x00,0x00,0x00,0xFC,0x00,0x48,0x44,0x4D,
  0x49,0x20,0x44,0x49,0x53,0x50,0x4C,0x41,0x59,0x0A,0x00,0x00,0x00,0x10,0x00,0x01,
  0x00,0x0A,0x00,0x0A,0x00,0x0A,0x0A,0x0A,0x0A,0x0A,0x20,0x0A,0x00,0x00,0x00,0x10,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x38
};

const uint8_t PROGMEM EDID::edid_800x480[EDID_SIZE] =
{
  0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x5C,0x34,0x01,0x00,0x01,0x00,0x00,0x00,
  0x01,0x19,0x01,0x03,0x80,0x00,0x00,0x00,0x0A,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
  0x01,0x01,0x01,0x01,0x01,0x01,0x1C,0x0C,0x20,0x80,0x30,0xE0,0x2D,0x10,0x28,0x30,
  0xD3,0x00,0x20,0xE0,0x31,0x00,0x00,0x18,0x00,0x00,0x00,0xFC,0x00,0x48,0x44,0x4D,
  0x49,0x20,0x44,0x49,0x53,0x50,0x4C,0x41,0x59,0x0A,0x00,0x00,0x00,0x10,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xB5
};

const uint8_t PROGMEM EDID::edid_800x480_720x480[EDID_SIZE] =
{
  0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x5C,0x34,0x01,0x00,0x01,0x00,0x00,0x00,
  0x01,0x19,0x01,0x03,0x80,0x00,0x00,0x00,0x0A,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
  0x01,0x01,0x01,0x01,0x01,0x01,0x1C,0x0C,0x20,0x80,0x30,0xE0,0x2D,0x10,0x28,0x30,
  0xD3,0x00,0x20,0xE0,0x31,0x00,0x00,0x18,0x00,0x00,0x00,0xFC,0x00,0x48,0x44,0x4D,
  0x49,0x20,0x44,0x49,0x53,0x50,0x4C,0x41,0x59,0x0A,0x8C,0x0A,0xD0,0x6C,0x20,0xE0,
  0x1E,0x10,0x10,0x3E,0x96,0x00,0xD0,0xE0,0x21,0x00,0x00,0x18,0x00,0x00,0x00,0x10,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xF8
};

const uint8_t PROGMEM EDID::edid_800x480HY[EDID_SIZE] =
{
  0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x5C,0x34,0x01,0x00,0x01,0x00,0x00,0x00,
  0x01,0x19,0x01,0x03,0x80,0x00,0x00,0x00,0x0A,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
  0x01,0x01,0x01,0x01,0x01,0x01,0xAA,0x0A,0x20,0x42,0x30,0xE0,0x2C,0x10,0x10,0x0A,
  0x51,0x04,0x20,0xE0,0x31,0x00,0x00,0x18,0x00,0x00,0x00,0xFC,0x00,0x48,0x44,0x4D,
  0x49,0x20,0x44,0x49,0x53,0x50,0x4C,0x41,0x59,0x0A,0x00,0x00,0x00,0x10,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x24
};

const uint8_t PROGMEM EDID::edid_1024x600[EDID_SIZE] =
{
  0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x5C,0x34,0x01,0x00,0x01,0x00,0x00,0x00,
  0x01,0x19,0x01,0x03,0x80,0x00,0x00,0x00,0x0A,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
  0x01,0x01,0x01,0x01,0x01,0x01,0xEC,0x13,0x00,0x80,0x40,0x58,0x2D,0x20,0x28,0x30,
  0xD3,0x00,0x00,0x58,0x42,0x00,0x00,0x18,0x00,0x00,0x00,0xFC,0x00,0x48,0x44,0x4D,
  0x49,0x20,0x44,0x49,0x53,0x50,0x4C,0x41,0x59,0x0A,0x00,0x00,0x00,0x10,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFD
};

EDID::EDID()
{
}

uint8_t EDID::readByte(uint8_t addr)
{
  uint8_t data = 0xFF;

  if(twi.beginTransmission(EEPROM_ADDR) == false)
  {
    twi.write(addr);
    twi.endTransmission();
    twi.requestFrom(EEPROM_ADDR, 1);
    for(unsigned long ms = millis(); !twi.available();)
    {
      if((millis()-ms) >= 500) // 500ms timeout
        break;
    }
    data = twi.read();
  }

  return data;
}

void EDID::writeByte(uint8_t addr, uint8_t data)
{
  if(twi.beginTransmission(EEPROM_ADDR) == false)
  {
    twi.write(addr);
    twi.write(data);
    twi.endTransmission();
  }
}

bool EDID::writeData(uint8_t *data, uint8_t length, bool fromProgMem)
{
  bool err = true;

  digitalWrite(LED_RED, HIGH);

  #if DEBUG > 0
    Serial.println(F("EDID: writing..."));
  #endif
  for(uint16_t addr = 0; addr < EEPROM_SIZE; addr++)
  {
    uint8_t b;

    #if USE_WATCHDOG > 0
      wdt_reset();
    #endif

    if(addr < length)
    {
      if(fromProgMem)
        b = pgm_read_byte(data + addr);
      else
        b = data[addr];
    }
    else
    {
      b = 0xFF;
    }

    writeByte((uint8_t)addr, b);
    delay(5);
  }
  #if DEBUG > 0
    Serial.println(F("EDID: verifying..."));
  #endif
  for(uint16_t addr = 0; addr < EEPROM_SIZE; addr++)
  {
    uint8_t b, d;

    #if USE_WATCHDOG > 0
      wdt_reset();
    #endif

    if(addr < length)
    {
      if(fromProgMem)
        b = pgm_read_byte(data + addr);
      else
        b = data[addr];
    }
    else
    {
      b = 0xFF;
    }

    d = readByte((uint8_t)addr);

    if(b != d)
    {
      #if DEBUG > 0
        Serial.print(F("EDID: verification failed at 0x"));
        Serial.println(addr, HEX);
      #endif
      err = false;
      break;
    }
  }

  digitalWrite(LED_RED, LOW);

  return err;
}

bool EDID::writeEDID(uint8_t display)
{
  uint8_t *data;

  #if DEBUG > 0
    Serial.print(F("EDID: "));
    Serial.println(display);
  #endif

  data = (uint8_t*)edid_unknown;

       if(display == DISPLAY_480x272)
    data = (uint8_t*)edid_480x272;
  else if(display == DISPLAY_800x480)
    data = (uint8_t*)edid_800x480;
  else if(display == DISPLAY_800x480_720x480)
    data = (uint8_t*)edid_800x480_720x480;
  else if(display == DISPLAY_800x480HY)
    data = (uint8_t*)edid_800x480HY;
  else if(display == DISPLAY_1024x600)
    data = (uint8_t*)edid_1024x600;
  else if((settings.data.screenWidth == 480) && (settings.data.screenHeight == 272))
    data = (uint8_t*)edid_480x272;
  else if((settings.data.screenWidth == 800) && (settings.data.screenHeight == 480))
    data = (uint8_t*)edid_800x480;
  else if((settings.data.screenWidth == 1024) && (settings.data.screenHeight == 600))
    data = (uint8_t*)edid_1024x600;

  return writeData((uint8_t*)data, EDID_SIZE, true);
}

/*
bool EDID::writeFromRam(void) // test
{
  char test[] = "0123456789";
  return writeData((uint8_t*)test, sizeof(test), false);
}
*/
